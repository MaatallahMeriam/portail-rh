<div class="collab-home">
  <app-header></app-header>

  <div class="main-content">
    <app-side-bar-manager></app-side-bar-manager>
    
    <div class="feed">
      <div class="container">
        <div class="header">
          <h2 class="title">Demandes Congés des membres</h2>
          <!-- Bouton "Enregistrer" supprimé -->
        </div>

        <!-- Ajout des onglets -->
        <div class="tabs">
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'pending'" 
            (click)="setActiveTab('pending')">
            Demandes à traiter
          </button>
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'history'" 
            (click)="setActiveTab('history')">
            Historique
          </button>
        </div>

        <!-- Vue des demandes en attente -->
        <section class="history-section" *ngIf="activeTab === 'pending'">
          <div class="history-content">
            <ngx-datatable
              class="material"
              [rows]="demandes"
              [columns]="columns"
              [columnMode]="'force'"
              [headerHeight]="50"
              [footerHeight]="50"
              [rowHeight]="50"
              [scrollbarH]="false"
              [scrollbarV]="true">
              
              <ngx-datatable-column name="Collaborateur" prop="userDetails" [width]="200">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div class="collaborateur-cell">
                    <img
                      [src]="getNormalizedImage(row.image)"
                      alt="Photo de {{ row.userDetails }}"
                      class="profile-photo"
                    />
                    <span>{{ row.userDetails }}</span>
                  </div>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Congés" prop="nomConges" [width]="120">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.nomConges }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Date Début" prop="dateDebut" [width]="110">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.dateDebut }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Date Fin" prop="dateFin" [width]="110">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.dateFin }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Durée" prop="dureeUnite" [width]="90">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.dureeUnite }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Solde" prop="solde" [width]="70">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.solde }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Actions" prop="actions" [width]="100">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div class="action-buttons">
                    <ng-container *ngIf="!row.isProcessing; else processingTemplate">
                      <button class="action-btn accept-btn" (click)="onAction(row, true)">
                        <span class="action-icon">✔</span>
                      </button>
                      <button class="action-btn reject-btn" (click)="onAction(row, false)">
                        <span class="action-icon">✖</span>
                      </button>
                    </ng-container>
                    <ng-template #processingTemplate>
                      <button class="cancel-btn" (click)="cancelAction(row)">
                        <span class="cancel-text">Annuler</span>
                        <span class="loading-ring"></span>
                      </button>
                    </ng-template>
                  </div>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-footer>
                <ng-template ngx-datatable-footer-template>
                  <div class="footer-total">
                    <span>{{ totalDemandes }} Demandes en totale</span>
                  </div>
                </ng-template>
              </ngx-datatable-footer>
            </ngx-datatable>
          </div>
        </section>

        <!-- Vue de l'historique (inchangée) -->
        <section class="history-section" *ngIf="activeTab === 'history'">
          <div class="history-content">
            <ngx-datatable
              class="material"
              [rows]="historyDemandes"
              [columns]="historyColumns"
              [columnMode]="'force'"
              [headerHeight]="50"
              [footerHeight]="50"
              [rowHeight]="50"
              [scrollbarH]="false"
              [scrollbarV]="true">
              
              <ngx-datatable-column name="Collaborateur" prop="userDetails" [width]="200">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div class="collaborateur-cell">
                    <img
                      [src]="getNormalizedImage(row.image)"
                      alt="Photo de {{ row.userDetails }}"
                      class="profile-photo"
                    />
                    <span>{{ row.userDetails }}</span>
                  </div>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Congés" prop="nomConges" [width]="120">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.nomConges }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Date Début" prop="dateDebut" [width]="110">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.dateDebut }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Date Fin" prop="dateFin" [width]="110">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.dateFin }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Durée" prop="dureeUnite" [width]="90">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span>{{ row.dureeUnite }}</span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-column name="Statut" prop="statut" [width]="100">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <span [ngClass]="{
                    'status-pending': row.statut === 'EN_ATTENTE',
                    'status-accepted': row.statut === 'VALIDEE',
                    'status-rejected': row.statut === 'REFUSEE'
                  }">
                    {{ row.statut }}
                  </span>
                </ng-template>
              </ngx-datatable-column>

              <ngx-datatable-footer>
                <ng-template ngx-datatable-footer-template>
                  <div class="footer-total">
                    <span>{{ totalHistoryDemandes }} Demandes en totale</span>
                  </div>
                </ng-template>
              </ngx-datatable-footer>
            </ngx-datatable>
          </div>
        </section>

        <!-- Calendrier visible uniquement dans l'onglet "Demandes en attente" -->
        <div class="container2" *ngIf="activeTab === 'pending'">
          <h3>Calendrier :</h3>
          <div class="calendar-card">
            <div class="calendar-header">
              <button class="nav-button" (click)="previousMonth()"><</button>
              <span class="month-year">{{ currentMonth }} {{ currentYear }}</span>
              <button class="nav-button" (click)="nextMonth()">></button>
            </div>
            <div class="calendar-grid">
              <div class="day-label" *ngFor="let day of daysOfWeek">{{ day }}</div>
              <div
                *ngFor="let day of calendarDays"
                class="calendar-day"
                [ngClass]="{
                  'filler': !day.isCurrentMonth,
                  'leave-day': day.usersOnLeave.length > 0,
                  'today': day.isToday
                }"
              >
                <span class="day-number">{{ day.date.getDate() }}</span>
                <div class="users-on-leave" *ngIf="day.usersOnLeave.length > 0">
                  <img
                    *ngFor="let user of day.usersOnLeave"
                    [src]="getNormalizedImage(user.image)"
                    [alt]="user.userDetails"
                    class="leave-photo"
                    [title]="user.userDetails"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Boîte de dialogue supprimée -->
      </div>
    </div>
  </div>
</div>